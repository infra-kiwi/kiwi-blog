# kiwi-blog-0007-cdk-cross-stack-references

This example shows multiple ways of using values generated by a stack, such as resources' ARNs, in another stack.

You can find the relative blog post at: https://blog.infra.kiwi/aws-cdk-cross-stack-references-54e52e2f8053

## Important files

* CDK entrypoint: [bin/app.ts](bin/app.ts)
* Example stacks:
  * Source stack with transparently-generated outputs: [lib/source-stack-with-outputs.ts](lib/source-stack-with-outputs.ts)
  * Source stack with semi-hardcoded names: [lib/source-stack-with-manual-names.ts](lib/source-stack-with-manual-names.ts)
  * Source stack with SSM parameters: [lib/source-stack-with-parameters.ts](lib/source-stack-with-parameters.ts)
  * The destinations stack, which supports importing the previous stacks' outputs: [lib/destination-stack.ts](lib/destination-stack.ts)

## Usage

Run:

```shell
npm install
npm run cdk:deploy:all
```

### Transparently-generated outputs

You can then see the transparently-generated output of the `SourceStackWithOutputs` stack using the following command:

```shell
aws cloudformation list-exports --query "Exports[? contains(ExportingStackId,'kiwi-blog-0007-cdk-cross-stack-references-SourceStackWithOutputs')]"
```

The command should return an output similar to:

```json
[
  {
    "ExportingStackId": "arn:aws:cloudformation:us-east-1:123456789012:stack/kiwi-blog-0007-cdk-cross-stack-references-SourceStackWithOutputs/53807860-045e-11ef-b963-0e0e787241bd",
    "Name": "kiwi-blog-0007-cdk-cross-stack-references-SourceStackWithOutputs:ExportsOutputRefMyTopic868694349D03D60F",
    "Value": "arn:aws:sns:us-east-1:123456789012:kiwi-blog-0007-cdk-cross-stack-references-SourceStackWithOutputs-MyTopic86869434-W4oZpBMxbSxU"
  }
]
```

Where `Value` contains the ARN of our SNS topic.

### SSM parameters

Verify the execution by fetching the value of the generated SSM command:

```shell
aws ssm get-parameter --name kiwi-blog-0007-cdk-cross-stack-references-SourceStackWithParameters-topic-arn --query 'Parameter.Value' --output text
```

The command should return an output similar to:

```
arn:aws:sns:us-east-1:123456789012:kiwi-blog-0007-cdk-cross-stack-references-SourceStackWithParameters-TopicBFC7AF6E-26y1MW6eMial
```

Where this value is the ARN of our SNS topic.

### Destroy

Then, you can destroy the deployed infrastructure with:

```shell
npm run cdk:destroy:all
```

## Useful commands

### CDK commands

```shell
# Performs a CDK diff against the current deployed environment
npm run cdk:diff

# Runs the CDK deployment
npm run cdk:deploy:all

# Destroys all the CDK deployment resources
npm run cdk:destroy:all

# Shows the synthesized CloudFormation templates
npm run cdk:synth -- kiwi-blog-0007-cdk-cross-stack-references-SourceStackWithOutputs
npm run cdk:synth -- kiwi-blog-0007-cdk-cross-stack-references-DestinationStackFromOutputs
npm run cdk:synth -- kiwi-blog-0007-cdk-cross-stack-references-SourceStackWithManualNames
npm run cdk:synth -- kiwi-blog-0007-cdk-cross-stack-references-DestinationStackFromManualNames
npm run cdk:synth -- kiwi-blog-0007-cdk-cross-stack-references-SourceStackWithParameters
npm run cdk:synth -- kiwi-blog-0007-cdk-cross-stack-references-DestinationStackFromParameters
```

### JS commands

```shell
# Run tests
npm run test

# Run lint
npm run lint
```
